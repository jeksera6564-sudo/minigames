<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Crystal Merge</title>

<style>
body{
  margin:0;
  font-family:Arial, sans-serif;
  background:radial-gradient(circle at top,#1c2042,#090b18);
  color:#fff;
  display:flex;
  flex-direction:column;
  align-items:center;
}

h1{margin:8px}

#stats{
  display:flex;
  gap:18px;
  font-size:16px;
}

#level{
  margin:6px 0 12px;
  font-weight:bold;
}

#board{
  position:relative;
  display:grid;
  grid-template-columns:repeat(5,72px);
  gap:10px;
}

.cell{
  width:72px;
  height:72px;
  background:#22275a;
  border-radius:18px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:30px;
  cursor:pointer;
  transition:transform .25s;
  box-shadow:0 0 12px rgba(0,0,0,.5);
}

.cell:hover{transform:scale(1.06)}
.cell.selected{outline:3px solid gold}

.merge{
  animation:merge .35s ease;
}
@keyframes merge{
  0%{transform:scale(1)}
  50%{transform:scale(1.5)}
  100%{transform:scale(1)}
}

.move{
  animation:move .25s ease;
}
@keyframes move{
  0%{transform:translate(var(--dx),var(--dy))}
  100%{transform:translate(0,0)}
}

.rare{box-shadow:0 0 16px 4px rgba(0,255,255,.7)}
.legendary{
  box-shadow:0 0 28px 8px rgba(255,215,0,.9);
  animation:pulse 1.4s infinite;
}
@keyframes pulse{
  0%{transform:scale(1)}
  50%{transform:scale(1.12)}
  100%{transform:scale(1)}
}

button{
  margin-top:12px;
  padding:10px 20px;
  border:none;
  border-radius:14px;
  background:#4cafef;
  color:#000;
  font-weight:bold;
  cursor:pointer;
}
button:disabled{opacity:.5}
</style>
</head>

<body>

<h1>üíé Crystal Merge</h1>

<div id="stats">
  <div>ü™ô <span id="coins">0</span></div>
  <div>‚ö° <span id="boosts">0</span></div>
</div>

<div id="level">
  –£—Ä–æ–≤–µ–Ω—å <span id="lvl">1</span> ¬∑ –¶–µ–ª—å <span id="goal">100</span> ü™ô
</div>

<div id="board"></div>

<button id="shuffleBtn">üîÄ –ü–µ—Ä–µ–º–µ—à–∞—Ç—å (1 –±—É—Å—Ç)</button>

<script>
const size=5;
const board=document.getElementById("board");
const coinsEl=document.getElementById("coins");
const boostsEl=document.getElementById("boosts");
const lvlEl=document.getElementById("lvl");
const goalEl=document.getElementById("goal");

const crystals=[
  {emoji:"üíé",type:"normal"},
  {emoji:"üî∑",type:"normal"},
  {emoji:"üîÆ",type:"normal"},
  {emoji:"üí†",type:"rare"},
  {emoji:"üü£",type:"rare"},
  {emoji:"üëë",type:"legendary"},
  {emoji:"üåü",type:"legendary"}
];

let cells=[], coins=0, boosts=0, level=1, selected=null;

const goalForLevel=l=>100+l*90;

function save(){
  localStorage.setItem("mergeSave",JSON.stringify({cells,coins,boosts,level}));
}
function load(){
  const d=localStorage.getItem("mergeSave");
  if(d){
    const s=JSON.parse(d);
    cells=s.cells; coins=s.coins; boosts=s.boosts; level=s.level;
  }else init();
}

function randomCrystal(){
  const r=Math.random();
  if(r<0.01) return {level:6};
  if(r<0.08) return {level:4};
  return {level:0};
}

function init(){
  cells=[];
  for(let i=0;i<size*size;i++) cells.push(randomCrystal());
  coins=0; boosts=0; level=1;
  save();
}

function render(){
  board.innerHTML="";
  cells.forEach((c,i)=>{
    const d=crystals[c.level]||crystals[0];
    const div=document.createElement("div");
    div.className="cell";
    div.textContent=d.emoji;
    if(d.type==="rare") div.classList.add("rare");
    if(d.type==="legendary") div.classList.add("legendary");
    if(selected===i) div.classList.add("selected");
    div.onclick=()=>clickCell(i);
    board.appendChild(div);
  });
  coinsEl.textContent=coins;
  boostsEl.textContent=boosts;
  lvlEl.textContent=level;
  goalEl.textContent=goalForLevel(level);
}

function clickCell(i){
  if(selected===null){selected=i; render(); return;}
  if(isNeighbor(selected,i)) animateMove(selected,i,()=>chainMerge(selected,i));
  selected=null;
}

function isNeighbor(a,b){
  const ax=a%size, ay=Math.floor(a/size);
  const bx=b%size, by=Math.floor(b/size);
  return Math.abs(ax-bx)+Math.abs(ay-by)===1;
}

function animateMove(a,b,cb){
  const el=board.children[a];
  const ax=a%size, ay=Math.floor(a/size);
  const bx=b%size, by=Math.floor(b/size);
  el.style.setProperty("--dx",(bx-ax)*82+"px");
  el.style.setProperty("--dy",(by-ay)*82+"px");
  el.classList.add("move");
  setTimeout(()=>{
    el.classList.remove("move");
    cb();
  },250);
}

function chainMerge(a,b){
  if(cells[a].level!==cells[b].level){render(); return;}

  let target=b, source=a;

  while(cells[source] && cells[target] && cells[source].level===cells[target].level){
    cells[target].level++;
    cells[source]=randomCrystal();

    let gain=10*cells[target].level;
    if(cells[target].level>=5) gain*=5;
    coins+=gain;

    const el=board.children[target];
    el.classList.add("merge");
    setTimeout(()=>el.classList.remove("merge"),300);

    source=findNeighborSame(target);
  }

  if(Math.random()<0.35) boosts++;
  checkLevel();
  save();
  render();
}

function findNeighborSame(i){
  const x=i%size, y=Math.floor(i/size);
  const dirs=[[1,0],[-1,0],[0,1],[0,-1]];
  for(const[dX,dY] of dirs){
    const nx=x+dX, ny=y+dY;
    if(nx>=0&&ny>=0&&nx<size&&ny<size){
      const ni=ny*size+nx;
      if(cells[ni].level===cells[i].level) return ni;
    }
  }
  return null;
}

function checkLevel(){
  if(coins>=goalForLevel(level)){
    level++;
    boosts+=2;
    // –º–µ—Å—Ç–æ –¥–ª—è —Ä–µ–∫–ª–∞–º—ã –Ø–Ω–¥–µ–∫—Å
    // ysdk.adv.showFullscreenAdv();
  }
}

document.getElementById("shuffleBtn").onclick=()=>{
  if(boosts<=0) return;
  boosts--;
  cells.sort(()=>Math.random()-.5);
  save();
  render();
};

load();
render();
</script>

</body>
</html>
